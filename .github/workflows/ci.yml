name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Build, Lint & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install forge-std
        working-directory: packages/contracts
        run: forge install foundry-rs/forge-std --no-git

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm db:generate

      - name: Build
        run: pnpm build

      - name: Lint
        run: pnpm lint

      - name: Test with coverage
        run: pnpm turbo test:coverage --filter=@mirrormarkets/shared --filter=@mirrormarkets/api --filter=@mirrormarkets/workers

      - name: Test contracts
        run: pnpm turbo test --filter=@mirrormarkets/contracts

      - name: Coverage summary
        if: always()
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for pkg in packages/shared services/api services/workers; do
            name=$(basename $pkg)
            report="$pkg/coverage/coverage-summary.json"
            if [ -f "$report" ]; then
              pct=$(node -e "const d=require('./$report').total; console.log('| ' + '$name' + ' | ' + d.lines.pct + '% | ' + d.branches.pct + '% | ' + d.functions.pct + '% | ' + d.statements.pct + '% |')")
              rows="${rows}${pct}\n"
            fi
          done
          echo "| Package | Lines | Branches | Functions | Statements |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|----------|-----------|------------|" >> $GITHUB_STEP_SUMMARY
          echo -e "$rows" >> $GITHUB_STEP_SUMMARY
